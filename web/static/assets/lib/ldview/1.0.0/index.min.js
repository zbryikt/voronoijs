(function(){function t(t,e){var n={}.hasOwnProperty;for(var i in e)n.call(e,i)&&(t[i]=e[i]);return t}function e(t,e){for(var n=-1,i=e.length>>>0;++n<i;)if(t===e[n])return!0;return!1}var n,i;n=function(e,n,i){return e.node.addEventListener(n,function(n){return i(t({evt:n},e))})},(i=function(t){var e,n,i,r,o,s,a,d,l,h;for(null==t&&(t={}),this.evtHandler={},this.ctxs=t.ctxs||null,this.views=[this].concat(t.baseViews||[]),this.ctx=t.context||t.ctx||null,t.context&&console.warn("[ldview] `context` is deprecated. use `ctx` instead."),this.attr=t.attr||{},this.style=t.style||{},this.handler=t.handler||{},this.action=t.action||{},this.text=t.text||{},this.initer=t.init||{},this.prefix=t.prefix,this.global=t.global||!1,this.ld=this.global?"pd":"ld",this.initRender=null==t.initRender||t.initRender,this.root="string"==typeof t.root?ld$.find(document,t.root,0):t.root,this.root||console.warn("[ldview] warning: no node found for root ",t.root),this.root.setAttribute&&!this.global&&(this.id="ld-"+Math.random().toString(36).substring(2),this.root.setAttribute("ld-scope-"+this.id,"")),(this.template=t.template)&&(this.root.textContent="",this.root.appendChild(this.template.cloneNode(!0))),this.update(),e={},n=0,s=(i=[function(){var t=[];for(r in this.initer)t.push(r);return t}.call(this)].concat([function(){var t=[];for(r in this.attr)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.style)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.text)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.handler)t.push(r);return t}.call(this)],function(){var t,e=[];for(r in t=this.action)o=t[r],e.push(o);return e}.call(this).map(function(t){var e,n=[];for(e in t)n.push(e);return n}))).length;n<s;++n)for(d=0,l=(a=i[n]).length;d<l;++d)e[a[d]]=!0;h=[];for(r in e)h.push(r);return this.names=h,this.initRender&&this.render(),this}).prototype=t(Object.create(Object.prototype),{update:function(t){var n,i,r,o,s,a,d,l=this;if(null==t&&(t=this.root),this.nodes||(this.nodes=[]),this.eaches||(this.eaches=[]),this.map||(this.map={nodes:{},eaches:{}}),n=this.prefix?"["+this.ld+"-each^="+this.prefix+"\\$]":"["+this.ld+"-each]",i=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+n),r=ld$.find(t,n),o=this.eaches.map(function(t){return t.n}),s=r.filter(function(t){return!e(t,i)}).filter(function(t){return!e(t,o)}).map(function(t){var e,n,i,r,o,s;if(!t.parentNode)return null;try{if(ld$.parent(t.parentNode,"*["+l.ld+"-each]"))return null}catch(t){t}return e=t.getAttribute(l.ld+"-each"),l.handler[e]?(n=t.parentNode,i=Array.from(n.childNodes).indexOf(t),r={idx:i,node:t,name:e,nodes:[]},o=document.createComment(" "+l.ld+"-each="+e+" "),l.handler[e].host||n.insertBefore(o,t),n.removeChild(t),o._data=r,r.proxy=o,r.container=(s=l.handler[e].host)?new s({root:n}):n,r):null}).filter(function(t){return t}),this.eaches=this.eaches.concat(s),s.map(function(t){var e,n;return((e=l.map.eaches)[n=t.name]||(e[n]=[])).push(t)}),n=this.prefix?"["+this.ld+"^="+this.prefix+"\\$]":"["+this.ld+"]",i=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+n),r=ld$.find(t,n),a=r.filter(function(t){return!(e(t,i)||e(t,l.nodes))}),this.nodes=this.nodes.concat(a),d=this.prefix?new RegExp("^"+this.prefix+"\\$"):null,a.map(function(t){var e;return e=(t.getAttribute(l.ld)||"").split(" "),l.prefix&&(e=e.map(function(t){return t.replace(d,"").trim()})),e.map(function(n){var i;return((i=l.map.nodes)[n]||(i[n]=[])).push({node:t,names:e,local:{},evts:{}})})}),!this.map.nodes["@"])return this.map.nodes["@"]=[{node:this.root,names:"@",local:{},evts:{}}]},procEach:function(t,n,i){var r,o,s,a,d,l,h,c,u,f,p,x,m,v,w=this;for(null==i&&(i=null),r=this.handler[t].list({name:n.name,node:n.node,views:this.views,context:this.ctx,ctx:this.ctx,ctxs:this.ctxs})||[],o=this.handler[t].key,s={},a=[],o?r.map(function(t){return s[o(t)]=t}):o=function(t){return t},d=n.nodes.filter(function(t){return t}).map(function(t){var i;return"object"!=typeof(i=o(t._data))&&!s[i]||"object"==typeof i&&!e(t._data,r)?(n.container.removeChild(t),t._data=null):a.push(i),t}).filter(function(t){return t._data}),(l=Array.from(n.container.childNodes).indexOf(n.proxy))<0&&(l=n.container.childNodes.length),h=[],c=r.length-1;c>=0;--c)f=r[u=c],(p=a.indexOf(o(f)))>=0?((x=d[p])._data=f,x._obj||(x._obj={node:x,name:t,idx:u,local:{}}),x._obj.data=f,Array.from(n.container.childNodes).indexOf(x)!==(m=l-(r.length-u))&&(n.container.removeChild(x),(l=Array.from(n.container.childNodes).indexOf(n.proxy))<0&&(l=n.container.childNodes.length),m=l-(r.length-u),n.container.insertBefore(x,n.container.childNodes[m+1]),l+=1),h.splice(0,0,x)):((x=n.node.cloneNode(!0))._data=f,x._obj={node:x,name:t,data:f,idx:u,local:{}},x.removeAttribute(this.ld+"-each"),m=l-(r.length-u),n.container.insertBefore(x,n.container.childNodes[m+1]),l+=1,h.splice(0,0,x));return v=h.filter(function(t){return t}),null!=i&&(v=v.filter(function(t){return e(o(t._obj.data),i)})),v.map(function(e,n){return w._render(t,e._obj,n,w.handler[t],!0)}),n.container.update&&n.container.update(),n.nodes=h},get:function(t){return((this.map.nodes[t]||[])[0]||{}).node},getAll:function(t){return(this.map.nodes[t]||[]).map(function(t){return t.node})},_render:function(e,r,o,s,a){var d,l,h,c,u,f,p,x,m,v,w=[];r.ctx=this.ctx,r.context=this.ctx,r.ctxs=this.ctxs,r.views=this.views,s?s.view?(d=function(e){var n,r,o,a,d,l,h;return n=e.node,r=e.local,o=e.data,a=e.ctx,d=e.ctxs,l=e.views,r._view=new i((h=t({ctx:o},s.view),h.initRender=!1,h.root=n,h.baseViews=l,h.ctxs=d?[a].concat(d):[a],h))},l=function(t){var e,n;return e=t.local,n=t.data,a&&e._view.setCtx(n),e._view.render()}):(d=s.init||null,l=s.handler||s.handle||null,h=s.text||null,c=s.attr||null,u=s.style||null,f=s.action||{}):(d=(p=[this.initer[e],this.handler[e],this.attr[e],this.style[e],this.text[e],this.action])[0],l=p[1],c=p[2],u=p[3],h=p[4],f=p[5]);try{if(d&&!(r.inited||(r.inited={}))[e]&&(d(r),r.inited[e]=!0),l&&l(r),h&&(r.node.textContent="function"==typeof h?h(r):h),c)for(x in p=c(r)||{})m=p[x],r.node.setAttribute(x,m);if(u)for(x in p=u(r)||{})m=p[x],r.node.style[x]=m;for(x in p=f||{})(m=p[x])&&(v=s?m:m[e])&&!(r.evts||(r.evts={}))[x]&&(n(r,x,v),w.push(r.evts[x]=!0));return w}catch(t){throw a=t,console.warn("[ldview] failed when rendering "+e+":",a),a}},bindEachNode:function(t){var e,n,i,r,o;if(e=t.name,n=t.container,i=t.idx,r=t.node,o=this.map.eaches[e].filter(function(t){return t.container===n})[0])return null!=i?o.nodes.splice(i,0,r):o.nodes.push(r)},unbindEachNode:function(t){var e,n,i,r,o;if(e=t.name,n=t.container,i=t.idx,r=t.node,o=this.map.eaches[e].filter(function(t){return t.container===n})[0])return r&&!i&&(i=o.nodes.indexOf(r)),o.nodes.splice(i,1)},render:function(t){var e,n,i,r,o,s,a,d,l=this;for(n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);if(e=n,this.fire("beforeRender"),o=function(t){var e,n;if("object"==typeof t&&(e=[t.name,t.key],t=e[0],n=e[1],Array.isArray(n)||(n=[n])),l.map.nodes[t]&&l.map.nodes[t].map(function(e,n){return e.name=t,e.idx=n,l._render(t,e,n,"object"==typeof l.handler[t]?{view:l.handler[t]}:null,!1)}),l.map.eaches[t]&&l.handler[t])return l.map.eaches[t].map(function(e){return l.procEach(t,e,n)})},t)(Array.isArray(t)?t:[t]).concat(e).map(function(t){return o(t)});else for(i=0,a=(s=this.names).length;i<a;++i)d=s[i],o(d);return this.fire("afterRender")},setContext:function(t){return console.warn("[ldview] `setContext` is deprecated. use `setCtx` instead."),this.ctx=t},setCtx:function(t){return this.ctx=t},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){var e,n,i,r,o,s,a,d=[];for(n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);for(e=n,i=0,s=(o=this.evtHandler[t]||[]).length;i<s;++i)a=o[i],d.push(a.apply(this,e));return d}}),"undefined"!=typeof module&&null!==module&&(module.exports=i),"undefined"!=typeof window&&null!==window&&(window.ldView=window.ldview=i)}).call(this);
